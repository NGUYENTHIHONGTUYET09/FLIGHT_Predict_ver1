{% extends "base.html" %}
{% block content %}
<div class="main-container">
    <h1 class="page-title">‚úàÔ∏è D·ª± ƒëo√°n ƒë·ªô tr·ªÖ chuy·∫øn bay</h1>
    <form method="POST" action="{{ url_for('predict') }}" class="prediction-form">
        <form method="POST" action="{{ url_for('predict') }}" class="prediction-form" id="predictForm">
        <div class="form-grid">
            <!-- C·ªôt 1: Ch·∫ø ƒë·ªô & M√¥ h√¨nh -->
            <div class="form-section">
                <div class="section-title"><span>üîß</span> Ch·∫ø ƒë·ªô & M√¥ h√¨nh</div>
                <label>Ch·ªçn ch·∫ø ƒë·ªô d·ª± ƒëo√°n:</label>
                <select id="mode" name="mode" onchange="togglePrevFlight()">
                        <option value="normal" {% if form_data.get('mode') == 'normal' %}selected{% endif %}>D·ª± ƒëo√°n th√¥ng th∆∞·ªùng</option>
                        <option value="prev_flight" {% if form_data.get('mode') == 'prev_flight' %}selected{% endif %}>D·ª± ƒëo√°n d·ª±a tr√™n chuy·∫øn bay tr∆∞·ªõc</option>
                </select>
                <label>Ch·ªçn m√¥ h√¨nh ML:</label>
                <select name="model" required>
                    <option value="LinearRegression_model">Linear Regression</option>
                    <option value="RandomForest_model">Random Forest</option>
                    <option value="XGBoost_model">XGBoost</option>
                    <option value="LightGBM_model">LightGBM</option>
                </select>
            </div>

            <!-- C·ªôt 2: Th√¥ng tin chuy·∫øn bay -->
            <div class="form-section">
                <div class="section-title"><span>üõ´</span> Th√¥ng tin chuy·∫øn bay</div>
                <label>Th·ªùi gian bay d·ª± ki·∫øn (ph√∫t):</label>
                    <input type="number" name="elapsed_time" min="1" required value="{{ form_data.get('elapsed_time','') }}">
                <label>Th·ªùi gian kh·ªüi h√†nh:</label>
                    <input type="datetime-local" name="departure_time" required value="{{ form_data.get('departure_time','') }}">
                <label>Tail Number:</label>
                    <input type="text" name="tail_number" maxlength="10" required value="{{ form_data.get('tail_number','') }}">
                <label>Carrier Code:</label>
                    <input type="text" name="carrier_code" maxlength="5" required value="{{ form_data.get('carrier_code','') }}">
                <label>Origin Airport:</label>
                    <input type="text" name="origin_airport" maxlength="5" required value="{{ form_data.get('origin_airport','') }}">
                <label>Destination Airport:</label>
                    <input type="text" name="destination_airport" maxlength="5" required value="{{ form_data.get('destination_airport','') }}">
            </div>

            <!-- C·ªôt 3: Th·ªùi ti·∫øt -->
            <div class="form-section">
                <div class="section-title"><span>üå¶Ô∏è</span> Th·ªùi ti·∫øt s√¢n bay ƒëi</div>
                <label>Nhi·ªát ƒë·ªô (¬∞C):</label>
                    <input type="number" step="0.1" name="temp_x" required value="{{ form_data.get('temp_x','') }}">
                <label>L∆∞·ª£ng m∆∞a (mm):</label>
                    <input type="number" step="0.1" name="precip_x" required value="{{ form_data.get('precip_x','') }}">
                <label>T·ªëc ƒë·ªô gi√≥ (km/h):</label>
                    <input type="number" step="0.1" name="wind_x" required value="{{ form_data.get('wind_x','') }}">

                <div class="section-title"><span>üå¶Ô∏è</span> Th·ªùi ti·∫øt s√¢n bay ƒë·∫øn</div>
                <label>Nhi·ªát ƒë·ªô (¬∞C):</label>
                    <input type="number" step="0.1" name="temp_y" required value="{{ form_data.get('temp_y','') }}">
                <label>L∆∞·ª£ng m∆∞a (mm):</label>
                    <input type="number" step="0.1" name="precip_y" required value="{{ form_data.get('precip_y','') }}">
                <label>T·ªëc ƒë·ªô gi√≥ (km/h):</label>
                    <input type="number" step="0.1" name="wind_y" required value="{{ form_data.get('wind_y','') }}">
            </div>
        </div>

        <!-- Prev flight container (toggled by JS) -->
        <div id="prev-flight-fields" style="display:none; width:100%; max-width:1400px; grid-column:1 / -1; margin-top:12px;">
            <div class="form-section" style="background:rgba(255,255,255,0.06); padding:12px; border-radius:6px;">
                <div class="section-title">‚èÆÔ∏è Th√¥ng tin chuy·∫øn bay tr∆∞·ªõc</div>
                <label>Th·ªùi gian kh·ªüi h√†nh chuy·∫øn tr∆∞·ªõc:</label>
                <input type="datetime-local" name="prev_departure_time">
                <label>Th·ªùi gian ƒë·∫øn n∆°i chuy·∫øn tr∆∞·ªõc:</label>
                <input type="datetime-local" name="prev_arrival_time">
            </div>
        </div>

        <button type="submit" class="btn-primary">üöÄ D·ª± ƒëo√°n ƒë·ªô tr·ªÖ chuy·∫øn bay</button>
    </form>
</div>

<style>
    .main-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box;
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: white;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        width: 100%;
        max-width: 1400px;
    }

    .form-section {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
    }

    input, select {
        width: 100%; /* M·ªü r·ªông chi·ªÅu ngang c·ªßa c√°c form */
        padding: 10px;
        margin-bottom: 15px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
    }

    input:focus, select:focus {
        outline: none;
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
    }

    .btn-primary {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #ff6f61;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #e64a45;
    }

    .section-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #ffdd57;
    }

    label {
        font-size: 14px;
        margin-bottom: 5px;
        display: block;
    }
</style>

{% if error %}
<div class="result-box" style="background:#ffebee; color:#b71c1c; border-color:#ef9a9a;">
    ‚ö†Ô∏è {{ error }}
</div>
{% endif %}

{% if prediction %}
<div class="result-box">
    ‚è±Ô∏è D·ª± ƒëo√°n ƒë·ªô tr·ªÖ: {{ prediction }} ph√∫t
</div>
{% endif %}

{% if form_data and prediction %}
<div class="result-box" style="background:#fffde7; color:#795548; border-color:#ffe082; text-align:left;">
    <b>Th√¥ng tin chuy·∫øn bay v·ª´a nh·∫≠p:</b><br>
    Ch·∫ø ƒë·ªô d·ª± ƒëo√°n: {{ form_data.mode }}<br>
    Th·ªùi gian bay d·ª± ki·∫øn: {{ form_data.elapsed_time }} ph√∫t<br>
    Th·ªùi gian kh·ªüi h√†nh: {{ form_data.departure_time|replace('T', ' ') }}<br>
    Tail Number: {{ form_data.tail_number }}<br>
    Carrier Code: {{ form_data.carrier_code }}<br>
    S√¢n bay ƒëi: {{ form_data.origin_airport }}<br>
    S√¢n bay ƒë·∫øn: {{ form_data.destination_airport }}<br>
    <b>Th·ªùi ti·∫øt s√¢n bay ƒëi:</b>
    Nhi·ªát ƒë·ªô: {{ form_data.temp_x }}¬∞C, M∆∞a: {{ form_data.precip_x }}mm, Gi√≥: {{ form_data.wind_x }}km/h<br>
    <b>Th·ªùi ti·∫øt s√¢n bay ƒë·∫øn:</b>
    Nhi·ªát ƒë·ªô: {{ form_data.temp_y }}¬∞C, M∆∞a: {{ form_data.precip_y }}mm, Gi√≥: {{ form_data.wind_y }}km/h<br>
    {% if form_data.mode == "prev_flight" %}
    <b>Th√¥ng tin chuy·∫øn tr∆∞·ªõc:</b>
    Xu·∫•t ph√°t: {{ form_data.prev_departure_time|replace('T', ' ') }}<br>
    ƒê·∫øn n∆°i: {{ form_data.prev_arrival_time|replace('T', ' ') }}
    {% endif %}
    <br>M√¥ h√¨nh ML: {{ form_data.model }}
</div>
{% endif %}

{% if prev_delay is not none %}
<div class="result-box" style="background:#e3f2fd; color:#0d47a1;">
    ƒê·ªô tr·ªÖ chuy·∫øn bay tr∆∞·ªõc: {{ prev_delay|round(2) }} ph√∫t
</div>
{% endif %}

{% if arrival_time_str %}
<div class="result-box" style="background:#e8f5e9; color:#1b5e20; border-color:#a5d6a7;">
    üõ¨ Th·ªùi gian ƒë·∫øn d·ª± ki·∫øn: {{ arrival_time_str }}
</div>
{% endif %}

<script>
function togglePrevFlight() {
    var mode = document.getElementById('mode').value;
    document.getElementById('prev-flight-fields').style.display = (mode === 'prev_flight') ? 'block' : 'none';
}

// Nh·∫≠p d·ªØ li·ªáu t·ª´ file JSON
function loadFromJSON() {
    const fileInput = document.getElementById('jsonFileInput');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
            if (data.mode) document.getElementsByName('mode')[0].value = data.mode;
            if (data.elapsed_time) document.getElementsByName('elapsed_time')[0].value = data.elapsed_time;
            if (data.departure_time) document.getElementsByName('departure_time')[0].value = data.departure_time;
            if (data.tail_number) document.getElementsByName('tail_number')[0].value = data.tail_number;
            if (data.carrier_code) document.getElementsByName('carrier_code')[0].value = data.carrier_code;
            if (data.origin_airport) document.getElementsByName('origin_airport')[0].value = data.origin_airport;
            if (data.destination_airport) document.getElementsByName('destination_airport')[0].value = data.destination_airport;
            if (data.temp_x) document.getElementsByName('temp_x')[0].value = data.temp_x;
            if (data.precip_x) document.getElementsByName('precip_x')[0].value = data.precip_x;
            if (data.wind_x) document.getElementsByName('wind_x')[0].value = data.wind_x;
            if (data.temp_y) document.getElementsByName('temp_y')[0].value = data.temp_y;
            if (data.precip_y) document.getElementsByName('precip_y')[0].value = data.precip_y;
            if (data.wind_y) document.getElementsByName('wind_y')[0].value = data.wind_y;
            if (data.model) document.getElementsByName('model')[0].value = data.model;
            if (data.prev_departure_time) document.getElementsByName('prev_departure_time')[0].value = data.prev_departure_time;
            if (data.prev_arrival_time) document.getElementsByName('prev_arrival_time')[0].value = data.prev_arrival_time;
            
            togglePrevFlight(); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã fields chuy·∫øn bay tr∆∞·ªõc
            alert('‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ file JSON th√†nh c√¥ng!');
        } catch (error) {
            alert('‚ùå L·ªói: File JSON kh√¥ng h·ª£p l·ªá!');
        }
    };
    reader.readAsText(file);
}

// Xu·∫•t d·ªØ li·ªáu form th√†nh file JSON
function exportToJSON() {
    const formData = {
        mode: document.getElementsByName('mode')[0].value,
        elapsed_time: document.getElementsByName('elapsed_time')[0].value,
        departure_time: document.getElementsByName('departure_time')[0].value,
        tail_number: document.getElementsByName('tail_number')[0].value,
        carrier_code: document.getElementsByName('carrier_code')[0].value,
        origin_airport: document.getElementsByName('origin_airport')[0].value,
        destination_airport: document.getElementsByName('destination_airport')[0].value,
        temp_x: document.getElementsByName('temp_x')[0].value,
        precip_x: document.getElementsByName('precip_x')[0].value,
        wind_x: document.getElementsByName('wind_x')[0].value,
        temp_y: document.getElementsByName('temp_y')[0].value,
        precip_y: document.getElementsByName('precip_y')[0].value,
        wind_y: document.getElementsByName('wind_y')[0].value,
        model: document.getElementsByName('model')[0].value,
        prev_departure_time: document.getElementsByName('prev_departure_time')[0].value,
        prev_arrival_time: document.getElementsByName('prev_arrival_time')[0].value,
        export_time: new Date().toISOString(),
        export_date: new Date().toLocaleDateString('vi-VN')
    };
    
    const jsonString = JSON.stringify(formData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const fileName = prompt('Nh·∫≠p t√™n file (kh√¥ng c·∫ßn .json):', 'flight_data_' + new Date().toISOString().slice(0,10));
    if (fileName) {
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
}

// Xu·∫•t PDF
function exportToPDF() {
    const fileName = prompt('Nh·∫≠p t√™n file PDF:', 'flight_prediction_' + new Date().toISOString().slice(0,10));
    if (!fileName) return;
    
    // Thu th·∫≠p d·ªØ li·ªáu form
    const formData = {
        mode: document.getElementsByName('mode')[0].value,
        elapsed_time: document.getElementsByName('elapsed_time')[0].value,
        departure_time: document.getElementsByName('departure_time')[0].value,
        tail_number: document.getElementsByName('tail_number')[0].value,
        carrier_code: document.getElementsByName('carrier_code')[0].value,
        origin_airport: document.getElementsByName('origin_airport')[0].value,
        destination_airport: document.getElementsByName('destination_airport')[0].value,
        temp_x: document.getElementsByName('temp_x')[0].value,
        precip_x: document.getElementsByName('precip_x')[0].value,
        wind_x: document.getElementsByName('wind_x')[0].value,
        temp_y: document.getElementsByName('temp_y')[0].value,
        precip_y: document.getElementsByName('precip_y')[0].value,
        wind_y: document.getElementsByName('wind_y')[0].value,
        model: document.getElementsByName('model')[0].value,
        prev_departure_time: document.getElementsByName('prev_departure_time')[0].value,
        prev_arrival_time: document.getElementsByName('prev_arrival_time')[0].value
    };
    
    // T·∫°o n·ªôi dung PDF
    const currentTime = new Date();
    const exportTime = currentTime.toLocaleString('vi-VN');
    
    const pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>B√°o c√°o D·ª± ƒëo√°n Chuy·∫øn bay</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { text-align: center; color: #1976d2; margin-bottom: 30px; }
        .info-section { margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .info-title { font-weight: bold; color: #1976d2; margin-bottom: 8px; }
        .export-info { text-align: center; color: #666; font-size: 12px; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚úàÔ∏è B√ÅO C√ÅO D·ª∞ ƒêO√ÅN ƒê·ªò TR·ªÑ CHUY·∫æN BAY</h1>
    </div>
    
    <div class="info-section">
        <div class="info-title">üîß Th√¥ng tin d·ª± ƒëo√°n</div>
        <p><strong>Ch·∫ø ƒë·ªô:</strong> ${formData.mode === 'normal' ? 'D·ª± ƒëo√°n th√¥ng th∆∞·ªùng' : 'D·ª± ƒëo√°n d·ª±a tr√™n chuy·∫øn bay tr∆∞·ªõc'}</p>
        <p><strong>M√¥ h√¨nh ML:</strong> ${formData.model}</p>
    </div>
    
    <div class="info-section">
        <div class="info-title">üõ´ Th√¥ng tin chuy·∫øn bay</div>
        <p><strong>Th·ªùi gian bay d·ª± ki·∫øn:</strong> ${formData.elapsed_time} ph√∫t</p>
        <p><strong>Th·ªùi gian kh·ªüi h√†nh:</strong> ${formData.departure_time?.replace('T', ' ') || 'Ch∆∞a nh·∫≠p'}</p>
        <p><strong>Tail Number:</strong> ${formData.tail_number}</p>
        <p><strong>Carrier Code:</strong> ${formData.carrier_code}</p>
        <p><strong>S√¢n bay ƒëi:</strong> ${formData.origin_airport}</p>
        <p><strong>S√¢n bay ƒë·∫øn:</strong> ${formData.destination_airport}</p>
    </div>
    
    <div class="info-section">
        <div class="info-title">üå¶Ô∏è Th√¥ng tin th·ªùi ti·∫øt</div>
        <p><strong>S√¢n bay ƒëi:</strong> Nhi·ªát ƒë·ªô ${formData.temp_x}¬∞C, M∆∞a ${formData.precip_x}mm, Gi√≥ ${formData.wind_x}km/h</p>
        <p><strong>S√¢n bay ƒë·∫øn:</strong> Nhi·ªát ƒë·ªô ${formData.temp_y}¬∞C, M∆∞a ${formData.precip_y}mm, Gi√≥ ${formData.wind_y}km/h</p>
    </div>
    
    ${formData.mode === 'prev_flight' && formData.prev_departure_time ? `
    <div class="info-section">
        <div class="info-title">‚èÆÔ∏è Th√¥ng tin chuy·∫øn bay tr∆∞·ªõc</div>
        <p><strong>Th·ªùi gian xu·∫•t ph√°t:</strong> ${formData.prev_departure_time?.replace('T', ' ') || 'Ch∆∞a nh·∫≠p'}</p>
        <p><strong>Th·ªùi gian ƒë·∫øn:</strong> ${formData.prev_arrival_time?.replace('T', ' ') || 'Ch∆∞a nh·∫≠p'}</p>
    </div>
    ` : ''}
    
    <div class="export-info">
        <p><strong>Th·ªùi gian xu·∫•t b√°o c√°o:</strong> ${exportTime}</p>
        <p><strong>T√™n file:</strong> ${fileName}.pdf</p>
        <p>H·ªá th·ªëng D·ª± ƒëo√°n ƒê·ªô tr·ªÖ Chuy·∫øn bay - Flight Prediction System</p>
    </div>
</body>
</html>`;
    
    // T·∫°o v√† t·∫£i PDF
    const printWindow = window.open('', '_blank');
    printWindow.document.write(pdfContent);
    printWindow.document.close();
    
    printWindow.onload = function() {
        printWindow.print();
        setTimeout(() => printWindow.close(), 1000);
    };
}

window.onload = togglePrevFlight;
</script>

{% endblock %}
